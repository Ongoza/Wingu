<!--
    TODO
        показывать количество линий
        для каждой линии триггер контроля: вход/выход/вход&выход
        нарисовать направления входа и выхода на линии
        сохранять картинку с камеры (без линий) в базу
        url может пыть локальный файл
        Определить разрешение камеры и фпс
        редактор линий:
            модальное окно в модальном окне конфиг-камера
            кликнуть на линии - выводит имя линии и ее параметры (контроль вход, выход или вход&выход)
-->

<html>
<head>
    <meta charset="UTF-8">
    <title>"Wingu:Cameras"</title>
    <link rel="icon" type="image/png" href="lib/favicon.png">
    <link href="lib/bootstrap.min.css" rel="stylesheet">
    <link href="lib/flag-icon.min.css" rel="stylesheet">
    <link href="js/main.css" rel="stylesheet">
    <script src="lib/jquery-3.5.1.min.js"></script>

    <script src="lib/bootstrap.min.js"></script>
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.1.0/css/flag-icon.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script> -->
    <!-- <script src="js/websocket.js"></script> -->
    <script src="js/websocket.js"></script>
    <script src="js/nav.js"></script>
    <script src="js/drawBorders.js"></script>

    <script>
        var divNewCamera = document.createElement('div');
        divNewCamera.id = 'divNewCamera';
        var curCamId = null;
        var curQeuensDisplay = [];
        divNewCamera.innerHTML = "";

        function showStream(id) {
            try {
                console.log("showStream", id);
                let arr = id.split('_');
                wsCmd.send(JSON.stringify({ "cmd": "startGetStream", "stream_id": arr[3] }));
                curQeuensDisplay.push(arr[3]);
            } catch (e) {
                console.log(e);
            }
        }

        function runCamera(e) {
            console.log("runCamera", e.parentElement.parentElement.id.slice(4), e);
            let id = e.parentElement.parentElement.id.slice(4);
            e.innerHTML = "Running";
            wsCmd.send(JSON.stringify({ "cmd": "startStream", "stream_id": id }));
        }
        //function saveCamera() {
        //    showCamList();
        //}

        function configViewUpdate(typeConfig) {
            console.log("start configViewUpdate()", typeConfig)
            try {
                if (typeConfig == 'streamsConfigList') {
                    if (localStorage.getItem('streamsConfigList') != null) {
                        let streamsConfigList = JSON.parse(localStorage.getItem('streamsConfigList'));
                        // console.log("streamsConfigList", typeof (streamsConfigList), streamsConfigList);
                        for (var name in streamsConfigList) {
                            addRow(name, streamsConfigList[name]);
                        };
                        //let gpusConfigList = JSON.parse(localStorage.getItem('gpusConfigList'));
                        //let streamsConfigList = JSON.parse(localStorage.getItem('streamsConfigList'));
                        //console.log("managerConfig", typeof (managerConfig), managerConfig);
                        //console.log("gpusConfigList", typeof (gpusConfigList), gpusConfigList);

                    } else {
                        console.log("Config is not ready!!");
                    }
                } else {
                    console.log("wrong type config!!");

                }
            } catch (error) {
                console.log(error);

            }
        }

        function confCameraFile() {

            $('#content').empty();
            $('#content').append(divNewCamera);
            if (curCamId == null) {
                $('#cam_borders').append('<button type="button" class="btn btn-primary" >Create</button>');
            } else {

            }
        }
        function confCamera() {
            // console.log(e);
            console.log("Camera: ", curCamId);
            let streamsConfigList = JSON.parse(localStorage.getItem('streamsConfigList'));
            if (curCamId in streamsConfigList) {
                console.log("File: ", streamsConfigList[curCamId]);
                $('#content').empty();
                $('#content').append(divNewCamera);
                if (curCamId == null) {
                    $('#cam_borders').append('<button type="button" class="btn btn-primary" >Create</button>');
                } else {
                    // id, url, skip_frames, isFromFile, save_path, save_video_res, save_video_flag
                    // res 320p, 480p, 720p
                    // console.log("streamsConfigList[curCamId]['borders']", )
                    $('#addStream_id').val(streamsConfigList[curCamId]['id']);
                    $('#addStream_name').val(streamsConfigList[curCamId]['name']);
                    $('#addStream_url').val(streamsConfigList[curCamId]['url']);
                    $('#addStream_skip_frames').val(streamsConfigList[curCamId]['skip_frames']);
                    if (streamsConfigList[curCamId]['isFromFile']) {
                        $('#addStream_isFromFile').prop('checked', true);
                    }
                    if (streamsConfigList[curCamId]['save_video_flag']) {
                        $('#addStream_save_video_flag').prop('checked', true);
                    }
                    $('#addStream_save_path').val(streamsConfigList[curCamId]['save_path']);
                    $('#addStream_save_video_res').val(streamsConfigList[curCamId]['save_video_res']);
                    $('#addStream_borders_number').val(Object.keys(streamsConfigList[curCamId]['borders']).length);
                    getFileImgAjax();
                }
            } else {
                alert("Config Error!!");
            }
        }

        function delCamera() {
            console.log("Delete Camera: ", curCamId);
            $('#camModal').modal('hide');

            curCamId = null;

        }


        function delCameraDlg() {
            console.log("Delete Camera: ", curCamId);
            $('#camModal').modal('show');
        }

        function showCamList() {
            curCamId = null;
            $('#content').empty();
            $('#content').append(divTable);
        }

        function addRow(name, data) {
            console.log("add row", name, data['id']);
            let path = "false";
            if (data['save_video_flag'] == true) {
                path = data['save_path'];
            }
            // console.log($('#camerasTable').find('tbody').children().length);
            let count = $('#camerasTable').find('tbody').children().length;
            $('#camerasTable').find('tbody')
                .append($('<tr>').attr('id', "row_" + name)
                    .append($('<td>').append(count + 1))
                    .append($('<td>').append(data['id']))
                    .append($('<td>').append(data['name']))
                    .append($('<td>').append(data['url']))
                    .append($('<td>').append(path))
                    .append($('<td>').append(data['display_video_flag']))
                    .append($('<td>').append(Object.keys(data['borders']).length))
                    .append($('<td>').append('<a href="#" onclick="runCamera(this); return false;">Run</a>'))
                    .append($('<td>').append('<a href="#" onclick="curCamId = this.parentElement.parentElement.id.slice(4); confCamera(); return false;">Change</a>'))
                    .append($('<td>').append('<a href="#" onclick="curCamId = this.parentElement.parentElement.id.slice(4); delCameraDlg(); return false;">Delete</a>'))
                );
        }

        let divTable = document.createElement('div');
        divTable.id = 'camerasTableDiv';
        divTable.innerHTML = `<table id="camerasTable" class="table table-striped table-hover table-sm table-bordered">
                            <thead class="thead-dark">
                            <tr>
                            <th scope="col">#</th>
                            <th scope="col">ID</th>
                            <th scope="col">Name</th>
                            <th scope="col">URL</th>
                            <th scope="col">SaveToFile</th>
                            <th scope="col">Display</th>
                            <th scope="col">Borders</th>
                            <th scope="col">Run|Stop</th>
                            <th scope="col">Edit</th>
                            <th scope="col">Delete</th>
                            </tr>
                            </thead>
                            <tbody id='camerasTableBody'></tbody>
                            </table>
                            <div class="btn-group" role="group" aria-label="">
                                <button type="button" class="btn btn-secondary" onclick="curCamId = null; confCamera(); return false;">New camera</button>
                                <button type="button" class="btn btn-secondary"  onclick="curCamId = null; confCameraFile(); return false;">New local file</button>
                            </div>
                            `;
        //function getCamerasList() {
        //    if (wsCmd != null) {
        //        if (wsCmd.readyState == 1) {
        //            wsCmd.send(JSON.stringify({ cmd: "getStreamsConfig" }));
        //        } else {
        //            console.log("Websocket is not ready. Wait a sec.")
        //            setTimeout(() => { getCamerasList(); }, 500);
        //        }
        //    } else { console.log("Error websocket does not exist!!"); }
        //}

        function getGpuList() {
            if (wsCmd != null) {
                if (wsCmd.readyState == 1) {
                    wsCmd.send(JSON.stringify({ "cmd": "getCameras" }));
                } else {
                    console.log("Websocket is not ready. Wait a sec.")
                    setTimeout(() => { getCamerasList(); }, 500);
                }
            } else { console.log("Error websocket does not exist!!"); }
        }

        function getStreamsConfig() {
            if (wsCmd != null) {
                if (wsCmd.readyState == 1) {
                    wsCmd.send(JSON.stringify({ "cmd": "getStreamsConfig" }));
                } else {
                    console.log("Websocket is not ready. Wait a sec.")
                    setTimeout(() => { getStreamsConfig(); }, 500);
                }
            } else { console.log("Error websocket does not exist!!"); }
        }

        function getManagerData() {
            if (wsCmd != null) {
                if (wsCmd.readyState == 1) {
                    wsCmd.send(JSON.stringify({ "cmd": "getManagerData" }));
                } else {
                    console.log("Websocket is not ready. Wait a sec.")
                    setTimeout(() => { getManagerData(); }, 500);
                }
            } else { console.log("Error websocket does not exist!!"); }
        }

        $(document).ready(function () {
            //getCamerasListAjax();
            //addRow(['id','name','online','counting','comments','url','borders']);
            if (wsCmd == null) { WebSocketCmd(); }
            //getCamerasList();
            getStreamsConfig();
            $.get('camera.html', function (data) {
                divNewCamera.innerHTML = data;
                //console.log(data);
            });
            showCamList();
        });
    </script>
</head>
<body>
    <div id="menu"></div>
    <h1 id="headMain"></h1>
    <div>
        <div class="card">
            <div class="card-body">
                <b>Hardware status: </b>
                <span class="badge badge-primary">CPU <span id="cpu">0</span>%</span>
                <span class="badge badge-primary">CPU <span id="cpu_t">0</span>&deg;</span>
                <span class="badge badge-primary">Mem <span id="mem_load">0</span>%</span>
                <span class="badge badge-primary">Drive <span id="drive_free">0</span>GB</span>
                <span class="badge badge-primary">GPU1 <span id="1gpu">0</span>%</span>
                <span class="badge badge-primary">GPU1 <span id="1gpu_t">0</span>&deg;</span>
                <span class="badge badge-primary">GPU1 <span id="1gpu_mem">0</span>GB</span>
                <span class="badge badge-primary">GPU2 <span id="2gpu">0</span>%</span>
                <span class="badge badge-primary">GPU2 <span id="2gpu_t">0</span>&deg;</span>
                <span class="badge badge-primary">GPU2 <span id="2gpu_mem">0</span>%</span>
            </div>
        </div>
        <br>
        <div class="card">
            <div class="card-header">Local files proceeding queue</div>
            <div class="card-body">
                <table class="table text-center table-sm">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Path</th>
                            <th scope="col">Size (MB)</th>
                            <th scope="col">Done (%)</th>
                            <th scope="col">Working (min)</th>
                            <th scope="col">Finished in (min)</th>
                            <th scope="col">Stop</th>
                            <th scope="col">Up|Down</th>
                            <th scope="col">Display</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="0_queue">
                            <td id="0_queue_n">1</td>
                            <td id="0_queue_path">39.avi</td>
                            <td id="0_queue_size">0</td>
                            <td>
                                <div class="progress"><div id="0_queue_done" class="progress-bar" role="progressbar" style="width:10%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div>
                                <!-- $('0_queue_done').css('width', valeu+'%').attr('aria-valuenow', valeu); -->
                            </td>
                            <td id="0_queue_proceed">0</td>
                            <td id="0_queue_finish">0</td>
                            <td><a href="#" style="color:red"><span class="fas fa-minus-circle"></span></a></td>
                            <td><a href="#" id="0_queue_n"><span class="fas fa-chevron-up"></span></a>&nbsp;&nbsp;<a href="#"><span class="fas fa-chevron-down"></span></a></a></td>
                            <td><a href="#" id ="0_queue_show_39 " onclick="showStream(this.id);" >Show</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <br>
        <div id="content">

        </div>
        <!-- Modal -->
        <div class="modal fade" id="camModal" tabindex="-1" role="dialog" aria-labelledby="ModalDelete" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="ModalDelete">Are you want delete camera config?</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Skip</button>
                        <button type="button" class="btn btn-danger" onclick="delCamera(); return false;">Delete</button>
                    </div>
                </div>
            </div>
        </div>
</body>
</html>