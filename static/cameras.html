<!--
    TODO
        показывать количество линий
        для каждой линии триггер контроля: вход/выход/вход&выход
        нарисовать направления входа и выхода на линии
        сохранять картинку с камеры (без линий) в базу
        url может пыть локальный файл
        Определить разрешение камеры и фпс
        редактор линий:
            модальное окно в модальном окне конфиг-камера
            кликнуть на линии - выводит имя линии и ее параметры (контроль вход, выход или вход&выход)
-->

<html>
<head>
    <meta charset="UTF-8">
    <title>"Wingu:Cameras"</title>
    <link rel="icon" type="image/png" href="lib/favicon.png">
    <link href="lib/bootstrap.min.css" rel="stylesheet">
    <link href="lib/flag-icon.min.css" rel="stylesheet">
    <link href="js/main.css" rel="stylesheet">
    <script src="lib/jquery-3.5.1.min.js"></script>

    <script src="lib/bootstrap.min.js"></script>
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.1.0/css/flag-icon.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script> -->
    <!-- <script src="js/websocket.js"></script> -->
    <script src="js/websocket.js"></script>
    <script src="js/nav.js"></script>
    <script>
        var divNewCamera = document.createElement('div');
        divNewCamera.id = 'divNewCamera';
        var curCamId = null;
        //'39': 
        // { 'id': 'test00', 
        //   'uid': 'lynE3ce', 
        // 'url': 'video/39.avi', 
        // 'isFromFile': True, 
        // 'save_path': 'video/39_out.avi', 
        // 'body_min_w': 64, 
        // 'path_track': 20, 
        // 'body_res': [256, 128], 
        // 'display_video_flag': True, 
        // 'max_cosine_distance': 0.2, 
        // 'save_video_flag': True, 
        // 'skip_frames': 0, 
        // 'encoder_filename': 'mars-small128.pb', 
        // 'batch_size': 32, 
        // 'img_size_start': [1600, 1200], 
        // 'save_video_res': [720, 540], 
        // 'borders': { 'border1': [[0, 104], [312, 104]] } }
        divNewCamera.innerHTML = `
                            <h2 id="head_page">Config<span></span></h2>
                            <form>

                            <div class="form-group row">
                            <label for="cam_name" class="col-sm-2 col-form-label col-form-label-sm">Id</label>
                            <div class="col-sm-10">
                            <input type="text" class="form-control form-control-sm" id="cam_id" placeholder="">
                            </div></div>

                            <div class="form-group row">
                            <label for="cam_name" class="col-sm-2 col-form-label col-form-label-sm">Name</label>
                            <div class="col-sm-10">
                            <input type="text" class="form-control form-control-sm" id="cam_name" placeholder="">
                            </div></div>

                            <div class="form-group row">
                            <label for="cam_name" class="col-sm-2 col-form-label col-form-label-sm">isFromFile</label>
                            <div class="col-sm-10">
                            <input type="text" class="form-control form-control-sm" id="cam_isFromFile" placeholder="">
                            </div></div>

                            <div class="form-group row">
                            <label for="cam_url" class="col-sm-2 col-form-label col-form-label-sm">Url</label>
                            <div class="col-sm-10">
                            <input type="text" class="form-control form-control-sm" id="cam_url" placeholder="rtsp://192.168.1.1:8070/video1">
                            </div></div>

                            <div class="form-group row">
                            <label for="cam_comments" class="col-sm-2 col-form-label col-form-label-sm">Comments</label>
                            <div class="col-sm-10">
                            <input type="text" class="form-control form-control-sm" id="cam_comments">
                            </div></div>

                            <div class="form-group row">
                            <label for="cam_borders" class="col-sm-2 col-form-label col-form-label-sm">Borders</label>
                            <div class="col-sm-10" id="cam_borders">
                            </div></div>

                            </form>
                            <div class="btn-group" role="group" aria-label="Save data">
                            <button type="button" class="btn btn-secondary" onclick="showCamList();return false;">Skip&Back</button>
                            <button type="button" class="btn btn-secondary" onclick="confCamera();return false;">Undo</button>
                            <button type="button" class="btn btn-secondary" onclick="saveCamera();return false;">Save&Back</button>
                            </div>
                            `;

        function clickRow(el) {
            console.log("id: ", el.id);
        }

        function saveCamera() {
            showCamList();
        }

        function configViewUpdate(typeConfig) {
            console.log("start configViewUpdate()", typeConfig)
            try {
                if (typeConfig == 'streamsConfigList') {                    
                    if (localStorage.getItem('streamsConfigList') != null) {
                        let streamsConfigList = JSON.parse(localStorage.getItem('streamsConfigList'));
                        console.log("streamsConfigList", typeof (streamsConfigList), streamsConfigList);
                        for (var name in streamsConfigList) {
                            addRow(name, streamsConfigList[name]);
                        };
                        //let gpusConfigList = JSON.parse(localStorage.getItem('gpusConfigList'));
                        //let streamsConfigList = JSON.parse(localStorage.getItem('streamsConfigList'));
                        //console.log("managerConfig", typeof (managerConfig), managerConfig);
                        //console.log("gpusConfigList", typeof (gpusConfigList), gpusConfigList);

                    } else {
                        console.log("Config is not ready!!");
                    }
                } else {
                    console.log("wrong type config!!");

                }
            } catch (error) {
                console.log(error);

            }
        }

        function confCameraFile() {
            console.log("File: ", curCamId);
            $('#content').empty();
            $('#content').append(divNewCamera);
            if (curCamId == null) {
                $('#cam_borders').append('<button type="button" class="btn btn-primary" >Create</button>');
            } else {

            }
        }
        function confCamera() {
            console.log("Camera: ", curCamId);
            $('#content').empty();
            $('#content').append(divNewCamera);
            if (curCamId == null) {
                $('#cam_borders').append('<button type="button" class="btn btn-primary" >Create</button>');
            } else {

            }
        }

        function delCamera() {
            console.log("Delete Camera: ", curCamId);
            $('#camModal').modal('hide');

            curCamId = null;

        }


        function delCameraDlg() {
            console.log("Delete Camera: ", curCamId);
            $('#camModal').modal('show');
        }

        function showCamList() {
            curCamId = null;
            $('#content').empty();
            $('#content').append(divTable);
        }

        //function getCamerasListAjax() {
        //    var jqxhr = $.ajax("http://localhost:8080/camerasList")
        //        .done(function (data) {
        //            console.log("success ajax", data.cameras);
        //            data.cameras.forEach((row) => { addRow(row); });
        //        })
        //        .fail(function () { console.log("error get ajax"); })
        //        .always(function () { console.log("complete ajax request"); });
        //}

        function addRow(name, data) {
            console.log("add row", name, data['id']);
            let path = "false";
            if (data['save_video_flag'] == true){
                path = data['save_path'];
            }
            // console.log($('#camerasTable').find('tbody').children().length);
            let count = $('#camerasTable').find('tbody').children().length;
            $('#camerasTable').find('tbody')
                .append($('<tr>').attr('id', "row_" + data['id'])
                    .append($('<td>').append(count + 1))
                    .append($('<td>').append(name))
                    .append($('<td>').append(data['id']))
                    .append($('<td>').append(data['url']))
                    .append($('<td>').append(path))
                    .append($('<td>').append(data['display_video_flag']))
                    .append($('<td>').append(data[5]))
                    .append($('<td>').append(Object.keys(data['borders']).length))
                    .append($('<td>').append('<a href="#" onclick="curCamId = this.parentElement.parentElement.id; confCamera(); return false;">Change</a>'))
                    .append($('<td>').append('<a href="#" onclick="curCamId = this.parentElement.parentElement.id; delCameraDlg(); return false;">Delete</a>'))
                );
        }

        let divTable = document.createElement('div');
        divTable.id = 'camerasTableDiv';
        divTable.innerHTML = `
                            <table id="camerasTable" class="table table-striped table-hover table-sm table-bordered">

                            <thead class="thead-dark">
                            <tr>
                            <th scope="col">#</th>
                            <th scope="col">ID</th>
                            <th scope="col">Name</th>
                            <th scope="col">URL</th>
                            <th scope="col">SaveToFile</th>
                            <th scope="col">Display</th>
                            <th scope="col">Online</th>
                            <th scope="col">Borders</th>
                            <th scope="col">Edit</th>
                            <th scope="col">Delete</th>
                            </tr>
                            </thead>
                            <tbody id='camerasTableBody'></tbody>
                            </table>
                            <div class="btn-group" role="group" aria-label="">
                                <button type="button" class="btn btn-secondary" onclick="curCamId = null; confCamera(); return false;">New camera</button>
                                <button type="button" class="btn btn-secondary"  onclick="curCamId = null; confCameraFile(); return false;">New local file</button>
                            </div>
                            `;

        function getCamerasList() {
            if (wsCmd != null) {
                if (wsCmd.readyState == 1) {
                    wsCmd.send(JSON.stringify({ cmd: "getCameras" }));
                } else {
                    console.log("Websocket is not ready. Wait a sec.")
                    setTimeout(() => { getCamerasList(); }, 500);
                }
            } else { console.log("Error websocket does not exist!!"); }
        }

        function getGpuList() {
            if (wsCmd != null) {
                if (wsCmd.readyState == 1) {
                    wsCmd.send(JSON.stringify({ "cmd": "getCameras" }));
                } else {
                    console.log("Websocket is not ready. Wait a sec.")
                    setTimeout(() => { getCamerasList(); }, 500);
                }
            } else { console.log("Error websocket does not exist!!"); }
        }

        function getManagerData() {
            if (wsCmd != null) {
                if (wsCmd.readyState == 1) {
                    wsCmd.send(JSON.stringify({ "cmd": "getManagerData" }));
                } else {
                    console.log("Websocket is not ready. Wait a sec.")
                    setTimeout(() => { getManagerData(); }, 500);
                }
            } else { console.log("Error websocket does not exist!!"); }
        }

        $(document).ready(function () {
            showCamList();
            //getCamerasListAjax();
            //addRow(['id','name','online','counting','comments','url','borders']);
            if (wsCmd == null) { WebSocketCmd(); }
            //getCamerasList();
            getManagerData();
        });
    </script>
</head>
<body>
    <div id="menu"></div>
    <h1 id="headMain"></h1>
    <div id="content">

    </div>
    <!-- Modal -->
    <div class="modal fade" id="camModal" tabindex="-1" role="dialog" aria-labelledby="ModalDelete" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalDelete">Are you want delete camera config?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Skip</button>
                    <button type="button" class="btn btn-danger" onclick="delCamera(); return false;">Delete</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>