<!--
    TODO
        показывать количество линий
        для каждой линии триггер контроля: вход/выход/вход&выход
        нарисовать направления входа и выхода на линии
        сохранять картинку с камеры (без линий) в базу
        url может пыть локальный файл
        Определить разрешение камеры и фпс
        редактор линий:
            модальное окно в модальном окне конфиг-камера
            кликнуть на линии - выводит имя линии и ее параметры (контроль вход, выход или вход&выход)
-->

<html>
<head>
    <meta charset="UTF-8">
    <title>"Wingu:Cameras"</title>
    <link rel="icon" type="image/png" href="lib/favicon.png">
    <link href="lib/bootstrap.min.css" rel="stylesheet">
    <link href="lib/flag-icon.min.css" rel="stylesheet">
    <script src="lib/jquery-3.5.1.min.js"></script>

    <script src="lib/bootstrap.min.js"></script>
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.1.0/css/flag-icon.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script> -->
    <!-- <script src="js/websocket.js"></script> -->
    <script src="js/websocket.js"></script>
    <script src="js/nav.js"></script>
    <script>
        var divNewCamera = document.createElement('div');
        divNewCamera.id = 'divNewCamera';
        var curCamId = null;
        divNewCamera.innerHTML = `
        <h2 id="head_page">Configuration</h2>
        <form>

        <div class="form-group row">
        <label for="cam_name" class="col-sm-2 col-form-label col-form-label-sm">Name</label>
        <div class="col-sm-10">
        <input type="text" class="form-control form-control-sm" id="cam_name" placeholder="">
        </div></div>

        <div class="form-group row">
        <label for="cam_url" class="col-sm-2 col-form-label col-form-label-sm">Url</label>
        <div class="col-sm-10">
        <input type="text" class="form-control form-control-sm" id="cam_url" placeholder="rtsp://192.168.1.1:8070/video1">
        </div></div>

        <div class="form-group row">
        <label for="cam_comments" class="col-sm-2 col-form-label col-form-label-sm">Comments</label>
        <div class="col-sm-10">
        <input type="text" class="form-control form-control-sm" id="cam_comments">
        </div></div>

        <div class="form-group row">
        <label for="cam_borders" class="col-sm-2 col-form-label col-form-label-sm">Borders</label>
        <div class="col-sm-10" id="cam_borders">
        </div></div>

        </form>
        <div class="btn-group" role="group" aria-label="Save data">
        <button type="button" class="btn btn-secondary" onclick="showCamList();return false;">Skip&Back</button>
        <button type="button" class="btn btn-secondary" onclick="confCamera();return false;">Undo</button>
        <button type="button" class="btn btn-secondary" onclick="saveCamera();return false;">Save&Back</button>
        </div>
        `;

        function clickRow(el){
        console.log("id: ", el.id);
        }

        function saveCamera(){

        showCamList();
        }

        function confCamera(){
        console.log("Camera: ",curCamId);
        $('#content').empty();
        $('#content').append(divNewCamera);
        if(curCamId == null){
        $('#cam_borders').append('<button type="button" class="btn btn-primary" >Create</button>');
        }else{

        }
        }

        function delCamera()
        {
        console.log("Delete Camera: ", curCamId);
        $('#camModal').modal('hide');

        curCamId = null;

        }


        function delCameraDlg(){
        console.log("Delete Camera: ", curCamId);
        $('#camModal').modal('show');
        }

        function showCamList(){
        curCamId = null;
        $('#content').empty();
        $('#content').append(divTable);
        }

        function getCamerasListAjax(){
        var jqxhr = $.ajax( "http://localhost:8080/camerasList" )
        .done(function(data) {
        console.log( "success ajax", data.cameras );
        data.cameras.forEach((row) => { addRow(row); });
        })
        .fail(function(){console.log( "error get ajax" ); })
        .always(function() { console.log( "complete ajax request" );  });
        }

        function addRow(data){
        // console.log($('#camerasTable').find('tbody').children().length);
        let count = $('#camerasTable').find('tbody').children().length;
        $('#camerasTable').find('tbody')
        .append($('<tr>').attr('id', "row_"+data[0])
        .append($('<td>').append(count+1))
        .append($('<td>').append(data[0]))
        .append($('<td>').append(data[1]))
        .append($('<td>').append(data[2]))
        .append($('<td>').append(data[3]))
        .append($('<td>').append(data[4]))
        .append($('<td>').append(data[5]))
        .append($('<td>').append(data[6]))
        .append($('<td>').append('<a href="#" onclick="curCamId = this.parentElement.parentElement.id; confCamera(); return false;">Change</a>'))
        .append($('<td>').append('<a href="#" onclick="curCamId = this.parentElement.parentElement.id; delCameraDlg(); return false;">Delete</a>'))
        );
        }

        let divTable = document.createElement('div');
        divTable.id = 'camerasTableDiv';
        divTable.innerHTML = `
        <table id="camerasTable" class="table table-striped table-hover table-sm table-bordered">
        <caption>List of cameras</caption>
        <thead class="thead-dark">
        <tr>
        <th scope="col">#</th>
        <th scope="col">ID</th>
        <th scope="col">Name</th>
        <th scope="col">Online</th>
        <th scope="col">Counting</th>
        <th scope="col">Comments</th>
        <th scope="col">URL</th>
        <th scope="col">Borders</th>
        <th scope="col">Edit</th>
        <th scope="col">Delete</th>
        </tr>
        </thead>
        <tbody id='camerasTableBody'></tbody>
        <tfoot style="border-top: 2px solid black;"><tr><td></td><td colspan="9"><a href="#" onclick="curCamId = null; confCamera(); return false;">Add new camera</a></td></tr></tfoot>
        </table>
        `;

        function getCamerasList(){
        if (wsCmd!=null){
        if (wsCmd.readyState == 1){
        wsCmd.send("getCameras");
        }else{
        console.log("Websocket is not ready. Wait a sec.")
        setTimeout(() => { getCamerasList(); }, 500);
        }
        }else{console.log("Error websocket does not exist!!");}
        }

        $(document).ready(function() {
        showCamList();
        //getCamerasListAjax();
        //addRow(['id','name','online','counting','comments','url','borders']);
        WebSocketCmd();
        getCamerasList();
        });
    </script>
</head>
<body>
    <div id="menu"></div>
    <h1 id="headMain">Cameras:</h1>
    <div id="content"></div>
    <!-- Modal -->
    <div class="modal fade" id="camModal" tabindex="-1" role="dialog" aria-labelledby="ModalDelete" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalDelete">Are you want delete camera config?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Skip</button>
                    <button type="button" class="btn btn-danger" onclick="delCamera(); return false;">Delete</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>