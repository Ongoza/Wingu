<html>
<head>
    <meta charset="UTF-8">
    <title>"Wingu:Home"</title>
    <link rel="icon" type="image/png" href="lib/favicon.png">
    <link href="lib/bootstrap.min.css" rel="stylesheet">
    <link href="lib/flag-icon.min.css" rel="stylesheet">
    <link href="js/main.css" rel="stylesheet">
    <script src="lib/jquery-3.5.1.min.js"></script>
    <script src="lib/moment.min.js"></script>
    <script src="lib/bootstrap.min.js"></script>

    <script src="lib/daterangepicker.js"></script>
    <link rel="stylesheet" href="lib/daterangepicker.css">

    <link rel="stylesheet" type="text/css" href="lib/jquery.dataTables.min.css" />
    <script type="text/javascript" src="lib/datatables.min.js"></script>

    <script src="js/websocket.js"></script>
    <script src="js/nav.js"></script>
    <!--<link rel="stylesheet" type="text/css" href="lib/jquery.datetimepicker.min.css" />-->

    <script>

        function addRowsStat(rows) {
            console.log("addRowsStat", rows);
            let table = $('#tableStat').find('tbody');
            let count = 0;
            let in_users = 0;
            let out_users = 0;
            for (var i in rows) {
                data = rows[i]
                let name = data[0];
                let inOut = "In";
                if (data[3] == 1) { inOut = "Out"; in_users++; }
                else { out_users++; }
                table
                    .append($('<tr>').attr('id', "stat_" + name)
                        .append($('<td>').append(count + 1).attr('id', "stat_num_" + (count + 1).toString()))
                        .append($('<td>').append(data[1]).attr('id', "stat_name_" + name))
                        .append($('<td>').append(data[2]).attr('id', "stat_border_" + name))
                        .append($('<td>').append(inOut).attr('id', "stat_inOut_" + name))
                        .append($('<td>').append(moment.unix(data[4]).format()).attr('id', "stat_time_" + name))
                    );
            }
            console.log("in_users", in_users, out_users);
            $('#in_users').text(in_users);
            $('#out_users').text(out_users);
        }

        $(function () {
            $('input[name="datetimes"]').daterangepicker({
                timePicker: true,
                startDate: moment().startOf('hour'),
                endDate: moment().startOf('hour').add(32, 'hour'),
                locale: { format: 'M/DD HH:MM' }
            });
        });

        function getServerSata() {

        }

        function getStats(params) {
            // data = stats_data;
            let statsAPI = '../stats'+params;
            $.getJSON(statsAPI, {format: "json"}).done(function (ans) {
                let json = JSON.parse(ans);
                console.log("data 1", typeof json);
                $('#spinner').remove();
                if (json.hasOwnProperty('getStats')) {
                    let count = 0;
                    let in_users = 0;
                    let out_users = 0;
                    let data = json['getStats']
                    let t = $('#tableStat').DataTable({
                        select: true,
                        columnDefs: [{
                            targets: [0],
                            orderData: [0, 1]
                        }, {
                            targets: [1],
                            orderData: [1, 0]
                        }, {
                            targets: [4],
                            orderData: [4, 0]
                        }]
                    });
                    // addRowsStat(data);
                    $.each(data, function (i, item) {
                        item[0] = i+1;
                        if (item[3] == 0) { item[3] = 'In', in_users++; }
                        else { item[3] = 'Out', out_users++;  };
                        item[4] = moment.unix(item[4]).format();
                        t.row.add(item).draw(true);
                    });
                    console.log("data ready");
                    $('#in_users').text(in_users);
                    $('#out_users').text(out_users);
                }
            }).fail(function () {
                $('#spinner').remove();                
                $('#alertInfo').html('<div class="alert alert-danger" role="alert">Error load data from server!</div>');
                console.log("error get json");
            })
                ;
        }

        $(document).ready(function () {
            // 24 hours = 86400 sec
            let startTime = Math.floor(Date.now() / 1000) - 3600;
            console.log("startTime", startTime, moment.unix(startTime).format())
            getStats('?time_start=' + startTime.toString());
            //value = "01/01/2018 - 01/15/2018";
        });
    </script>

</head>
<body>
    <div id="menu"></div>
    <h1 id="headMain"></h1>
    <br>
    <div class="card">
        <div class="card-header">Request to Database for data</div>
        <div class="card-body">
            <div id="dbRequest">
                <form>
                    <div class="input-group mb-auto">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Date range</span>
                        </div>
                        <input type="text" name="datetimes" id="queue_timeRange" />

                        <div class="input-group-prepend">
                            <span class="input-group-text">Camera</span>
                        </div>
                        <input type="text" class="form-control" id="queue_camera" value="">

                        <div class="input-group-prepend">
                            <span class="input-group-text">Border</span>
                        </div>
                        <input type="text" class="form-control" id="queue_border" value="">

                        <div class="input-group-prepend">
                            <span class="input-group-text">In|Out</span>
                        </div>
                        <input type="text" class="form-control" id="queue_inOut" value="">

                        <button type="button" class="btn btn-primary" onclick="getServerSata();">Get data</button>

                    </div>


                </form>
            </div>
        </div>
    </div>
    <div class="card">
        <div>
            <b>Total users in request</b>
            <span class="badge badge-primary">In:<span id="in_users"></span></span>
            <span class="badge badge-info">Out:<span id="out_users"></span></span>

        </div>
        <div class="card-body">
            <table id="tableStat" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Border</th>
                        <th>Camera</th>
                        <th>In|Out</th>
                        <th>Time</th>
                    </tr>
                </thead>
            </table>
            <div class="d-flex justify-content-center" id="alertInfo">
                <div class="spinner-border" role="status"  id="spinner">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        </div>
    </div>

</body>
</html>